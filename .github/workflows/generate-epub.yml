name: Generate EPUB from Markdown

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  generate-epub:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pandoc
      uses: r-lib/actions/setup-pandoc@v2
      
    - name: Install fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk
        
    - name: Create EPUB metadata
      run: |
        cat > metadata.yaml << 'EOF'
        ---
        title: "Happy-LLM å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹"
        author: "DataWhale"
        language: zh-CN
        subject: "å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹"
        description: "ä»NLPåŸºç¡€æ¦‚å¿µåˆ°å¤§æ¨¡å‹åº”ç”¨çš„å®Œæ•´æ•™ç¨‹ï¼ŒåŒ…å«ç†è®ºçŸ¥è¯†å’Œå®è·µä»£ç "
        publisher: "DataWhale"
        rights: "CC BY-NC-SA 4.0"
        identifier: "happy-llm-tutorial"
        cover-image: "docs/images/head.jpg"
        ---
        EOF
        
    - name: Create EPUB style
      run: |
        cat > epub-style.css << 'EOF'
        @charset "UTF-8";
        
        body {
          font-family: "Noto Sans CJK SC", "Microsoft YaHei", "SimSun", "PingFang SC", serif;
          line-height: 1.6;
          margin: 2em;
          color: #333;
          font-size: 16px;
        }
        
        h1 {
          color: #2c3e50;
          border-bottom: 2px solid #3498db;
          padding-bottom: 0.3em;
          margin-top: 2em;
          margin-bottom: 1em;
          font-size: 1.8em;
        }
        
        h2 {
          color: #34495e;
          border-bottom: 1px solid #bdc3c7;
          padding-bottom: 0.2em;
          margin-top: 1.5em;
          margin-bottom: 0.8em;
          font-size: 1.4em;
        }
        
        h3 {
          color: #7f8c8d;
          margin-top: 1.2em;
          margin-bottom: 0.6em;
          font-size: 1.2em;
        }
        
        h4, h5, h6 {
          color: #95a5a6;
          margin-top: 1em;
          margin-bottom: 0.5em;
        }
        
        p {
          margin-bottom: 1em;
          text-align: justify;
        }
        
        code {
          background-color: #f8f9fa;
          padding: 0.2em 0.4em;
          border-radius: 3px;
          font-family: "Consolas", "Monaco", "Courier New", "Source Code Pro", monospace;
          font-size: 0.9em;
          color: #e74c3c;
        }
        
        pre {
          background-color: #f8f9fa;
          padding: 1em;
          border-radius: 5px;
          overflow-x: auto;
          border-left: 4px solid #3498db;
          margin: 1em 0;
        }
        
        pre code {
          background-color: transparent;
          padding: 0;
          color: #333;
        }
        
        blockquote {
          border-left: 4px solid #3498db;
          margin: 1em 0;
          padding-left: 1em;
          color: #7f8c8d;
          background-color: #f8f9fa;
          padding: 1em;
          border-radius: 0 5px 5px 0;
        }
        
        img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 1em auto;
          border-radius: 5px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table {
          border-collapse: collapse;
          width: 100%;
          margin: 1em 0;
          font-size: 0.9em;
        }
        
        th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
        }
        
        th {
          background-color: #f2f2f2;
          font-weight: bold;
        }
        
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
        
        ul, ol {
          margin: 1em 0;
          padding-left: 2em;
        }
        
        li {
          margin-bottom: 0.5em;
        }
        
        a {
          color: #3498db;
          text-decoration: none;
        }
        
        a:hover {
          text-decoration: underline;
        }
        
        .highlight {
          background-color: #fff3cd;
          padding: 0.2em 0.4em;
          border-radius: 3px;
        }
        
        .warning {
          background-color: #f8d7da;
          color: #721c24;
          padding: 1em;
          border-radius: 5px;
          border-left: 4px solid #dc3545;
          margin: 1em 0;
        }
        
        .info {
          background-color: #d1ecf1;
          color: #0c5460;
          padding: 1em;
          border-radius: 5px;
          border-left: 4px solid #17a2b8;
          margin: 1em 0;
        }
        EOF
        
    - name: Prepare markdown files
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_epub
        
        # å®šä¹‰è¦å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆä½¿ç”¨æ•°ç»„è€Œä¸æ˜¯å…³è”æ•°ç»„ï¼Œæ›´å…¼å®¹ï¼‰
        files=(
          "docs/README.md:00-README.md"
          "docs/å‰è¨€.md:01-å‰è¨€.md"
          "docs/chapter1/ç¬¬ä¸€ç«  NLPåŸºç¡€æ¦‚å¿µ.md:02-ç¬¬ä¸€ç« -NLPåŸºç¡€æ¦‚å¿µ.md"
          "docs/chapter2/ç¬¬äºŒç«  Transformeræ¶æ„.md:03-ç¬¬äºŒç« -Transformeræ¶æ„.md"
          "docs/chapter3/ç¬¬ä¸‰ç«  é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹.md:04-ç¬¬ä¸‰ç« -é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹.md"
          "docs/chapter4/ç¬¬å››ç«  å¤§è¯­è¨€æ¨¡å‹.md:05-ç¬¬å››ç« -å¤§è¯­è¨€æ¨¡å‹.md"
          "docs/chapter5/ç¬¬äº”ç«  åŠ¨æ‰‹æ­å»ºå¤§æ¨¡å‹.md:06-ç¬¬äº”ç« -åŠ¨æ‰‹æ­å»ºå¤§æ¨¡å‹.md"
          "docs/chapter6/ç¬¬å…­ç«  å¤§æ¨¡å‹è®­ç»ƒæµç¨‹å®è·µ.md:07-ç¬¬å…­ç« -å¤§æ¨¡å‹è®­ç»ƒæµç¨‹å®è·µ.md"
          "docs/chapter7/ç¬¬ä¸ƒç«  å¤§æ¨¡å‹åº”ç”¨.md:08-ç¬¬ä¸ƒç« -å¤§æ¨¡å‹åº”ç”¨.md"
        )
        
        # å¤åˆ¶æ–‡ä»¶å¹¶æ£€æŸ¥
        copied_count=0
        for file_pair in "${files[@]}"; do
          IFS=':' read -r source target <<< "$file_pair"
          if [[ -f "$source" ]]; then
            cp "$source" "temp_epub/$target"
            echo "âœ“ å¤åˆ¶: $(basename "$source")"
            ((copied_count++))
          else
            echo "âš ï¸  è­¦å‘Š: $source ä¸å­˜åœ¨"
          fi
        done
        
        if [[ $copied_count -eq 0 ]]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•markdownæ–‡ä»¶"
          exit 1
        fi
        
        echo "ğŸ“Š æˆåŠŸå¤åˆ¶ $copied_count ä¸ªæ–‡ä»¶"
        echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨:"
        ls -la temp_epub/
        
    - name: Generate EPUB
      run: |
        echo "ğŸ”„ å¼€å§‹ç”ŸæˆEPUBæ–‡ä»¶..."
        
        # æ£€æŸ¥å°é¢å›¾ç‰‡
        if [[ ! -f "docs/images/head.jpg" ]]; then
          echo "âš ï¸  è­¦å‘Š: å°é¢å›¾ç‰‡ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤å°é¢"
          cover_option=""
        else
          cover_option="--epub-cover-image=docs/images/head.jpg"
        fi
        
        # ç”ŸæˆEPUB
        pandoc \
          --from markdown \
          --to epub \
          --metadata-file=metadata.yaml \
          --css=epub-style.css \
          $cover_option \
          --toc \
          --toc-depth=3 \
          --number-sections \
          --epub-chapter-level=1 \
          --verbose \
          -o "Happy-LLM-æ•™ç¨‹.epub" \
          temp_epub/*.md
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… EPUBæ–‡ä»¶ç”ŸæˆæˆåŠŸ!"
          ls -lh "Happy-LLM-æ•™ç¨‹.epub"
          
          # éªŒè¯æ–‡ä»¶
          if [[ -f "Happy-LLM-æ•™ç¨‹.epub" ]]; then
            file_size=$(stat -c%s "Happy-LLM-æ•™ç¨‹.epub" 2>/dev/null || stat -f%z "Happy-LLM-æ•™ç¨‹.epub" 2>/dev/null || echo "unknown")
            echo "ğŸ“ æ–‡ä»¶å¤§å°: $file_size bytes"
          else
            echo "âŒ é”™è¯¯: EPUBæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
        else
          echo "âŒ EPUBæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    - name: Upload EPUB artifact
      uses: actions/upload-artifact@v4
      with:
        name: Happy-LLM-æ•™ç¨‹.epub
        path: Happy-LLM-æ•™ç¨‹.epub
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: Happy-LLM-æ•™ç¨‹.epub
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - Happy-LLMæ•™ç¨‹EPUB
        body: |
          ## Happy-LLM å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹ EPUBç‰ˆæœ¬
          
          è‡ªåŠ¨ç”Ÿæˆçš„EPUBç”µå­ä¹¦ï¼ŒåŒ…å«å®Œæ•´çš„æ•™ç¨‹å†…å®¹ã€‚
          
          ### ğŸ“š åŒ…å«ç« èŠ‚
          - å‰è¨€
          - ç¬¬ä¸€ç«  NLPåŸºç¡€æ¦‚å¿µ
          - ç¬¬äºŒç«  Transformeræ¶æ„
          - ç¬¬ä¸‰ç«  é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹
          - ç¬¬å››ç«  å¤§è¯­è¨€æ¨¡å‹
          - ç¬¬äº”ç«  åŠ¨æ‰‹æ­å»ºå¤§æ¨¡å‹
          - ç¬¬å…­ç«  å¤§æ¨¡å‹è®­ç»ƒæµç¨‹å®è·µ
          - ç¬¬ä¸ƒç«  å¤§æ¨¡å‹åº”ç”¨
          
          ### ğŸ“– é˜…è¯»å»ºè®®
          - æ”¯æŒç›®å½•å¯¼èˆª
          - åŒ…å«ä»£ç é«˜äº®
          - é€‚é…ä¸­æ–‡æ˜¾ç¤º
          - åŒ…å«å›¾ç‰‡å’Œè¡¨æ ¼
          
          ### ğŸ”§ æŠ€æœ¯ç»†èŠ‚
          - ä½¿ç”¨pandocè½¬æ¢
          - è‡ªå®šä¹‰CSSæ ·å¼
          - æ”¯æŒä¸­æ–‡æ’ç‰ˆ
          - è‡ªåŠ¨ç”Ÿæˆç›®å½•
          
          ---
          
          *æ­¤æ–‡ä»¶ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆäº ${{ github.event.head_commit.timestamp }}*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 