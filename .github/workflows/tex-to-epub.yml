name: Convert TEX to EPUB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  convert-tex-to-epub:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pandoc
      uses: r-lib/actions/setup-pandoc@v2
      
    - name: Install LaTeX tools
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-lang-chinese texlive-fonts-recommended
        sudo apt-get install -y fonts-noto-cjk
        
    - name: Check single chapter tex files
      run: |
        echo "检查各章节的独立tex文件..."
        cd docs/tex_output
        
        chapter_files=(
          "main_前言.tex"
          "main_第一章.tex"
          "main_第二章.tex"
          "main_第三章.tex"
          "main_第四章.tex"
          "main_第五章.tex"
          "main_第六章.tex"
          "main_第七章.tex"
        )
        
        for file in "${chapter_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ $file 文件不存在"
            exit 1
          fi
          echo "✓ $file 存在"
        done
        
        echo "✓ 所有章节文件检查完成"
        
    - name: Create EPUB metadata
      run: |
        cat > docs/tex_output/metadata.yaml << 'EOF'
        ---
        title: "Happy-LLM 大语言模型教程"
        subtitle: "从理论到实践"
        author: "DataWhale"
        language: zh-CN
        subject: "大语言模型教程"
        description: "从NLP基础概念到大模型应用的完整教程，包含理论知识和实践代码"
        publisher: "DataWhale"
        rights: "CC BY-NC-SA 4.0"
        identifier: "happy-llm-tutorial"
        cover-image: "docs/images/head.jpg"
        ---
        EOF
        
    - name: Check EPUB style file
      run: |
        echo "检查EPUB样式文件..."
        if [ ! -f "docs/tex_output/epub-style.css" ]; then
          echo "❌ epub-style.css 文件不存在"
          exit 1
        fi
        
        echo "✓ EPUB样式文件检查完成"
        
    - name: Test each chapter individually
      run: |
        cd docs/tex_output
        
        echo "🔍 开始测试每个章节的编译..."
        
        chapter_files=(
          "main_前言.tex:前言"
          "main_第一章.tex:第一章"
          "main_第二章.tex:第二章"
          "main_第三章.tex:第三章"
          "main_第四章.tex:第四章"
          "main_第五章.tex:第五章"
          "main_第六章.tex:第六章"
          "main_第七章.tex:第七章"
        )
        
        failed_chapters=()
        
        for file_info in "${chapter_files[@]}"; do
          IFS=':' read -r file chapter_name <<< "$file_info"
          
          echo "📖 测试 $chapter_name ($file)..."
          
          # 尝试编译为EPUB
          if pandoc "$file" \
            --from latex \
            --to epub \
            --output "${chapter_name}_test.epub" \
            --metadata-file=metadata.yaml \
            --css=epub-style.css \
            --toc \
            --number-sections \
            --epub-cover-image=../images/head.jpg 2>&1; then
            
            echo "✅ $chapter_name 编译成功"
            rm -f "${chapter_name}_test.epub"
          else
            echo "❌ $chapter_name 编译失败"
            failed_chapters+=("$chapter_name")
          fi
        done
        
        echo ""
        echo "📊 编译结果汇总:"
        if [ ${#failed_chapters[@]} -eq 0 ]; then
          echo "🎉 所有章节编译成功！"
        else
          echo "⚠️  以下章节编译失败:"
          for chapter in "${failed_chapters[@]}"; do
            echo "   - $chapter"
          done
          echo ""
          echo "请检查上述章节的tex文件内容"
        fi
        
    - name: Convert main tex to EPUB
      run: |
        cd docs/tex_output
        
        echo "📚 开始编译完整的main.tex为EPUB..."
        
        # 使用main.tex编译为EPUB
        pandoc main.tex \
          --from latex \
          --to epub \
          --output "Happy-LLM-教程.epub" \
          --metadata-file=metadata.yaml \
          --css=epub-style.css \
          --toc \
          --number-sections \
          --epub-cover-image=../images/head.jpg
        
        echo "EPUB生成完成！"
        ls -lh Happy-LLM-教程.epub
        
        # 检查文件大小
        file_size=$(stat -c%s "Happy-LLM-教程.epub")
        echo "文件大小: $file_size 字节"
        
        if [ $file_size -lt 100000 ]; then
          echo "❌ EPUB文件过小，可能生成失败"
          exit 1
        fi
        
        echo "✓ EPUB文件生成成功，大小: $file_size 字节"
        
    - name: Upload EPUB artifact
      uses: actions/upload-artifact@v4
      with:
        name: Happy-LLM-教程.epub
        path: docs/tex_output/Happy-LLM-教程.epub
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: docs/tex_output/Happy-LLM-教程.epub
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - Happy-LLM教程EPUB
        body: |
          ## Happy-LLM 大语言模型教程 EPUB版本
          
          自动生成的EPUB电子书，包含完整的教程内容。
          
          ### 📚 包含章节
          - 前言
          - 第一章 NLP基础概念
          - 第二章 Transformer架构
          - 第三章 预训练语言模型
          - 第四章 大语言模型
          - 第五章 动手搭建大模型
          - 第六章 大模型训练流程实践
          - 第七章 大模型应用
          
          ### 📖 特性
          - 支持目录导航
          - 代码高亮显示
          - 适配中文排版
          - 包含图片和表格
          
          ### 🚀 使用方法
          1. 下载EPUB文件
          2. 使用支持EPUB的阅读器打开
          3. 推荐：Calibre、Apple Books、Kindle
          
          ### 📞 反馈
          - [GitHub Issues](https://github.com/datawhalechina/happy-llm/issues)
          - [讨论区](https://github.com/datawhalechina/happy-llm/discussions)
          
          ---
          *自动生成于 ${{ github.event.head_commit.timestamp }}*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 