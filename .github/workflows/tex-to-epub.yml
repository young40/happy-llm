name: Convert TEX to EPUB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  convert-tex-to-epub:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pandoc
      uses: r-lib/actions/setup-pandoc@v2
      
    - name: Install LaTeX tools
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-lang-chinese texlive-fonts-recommended
        sudo apt-get install -y fonts-noto-cjk
        
    - name: Check single chapter tex files
      run: |
        echo "æ£€æŸ¥å„ç« èŠ‚çš„ç‹¬ç«‹texæ–‡ä»¶..."
        cd docs/tex_output
        
        chapter_files=(
          "main_å‰è¨€.tex"
          "main_ç¬¬ä¸€ç« .tex"
          "main_ç¬¬äºŒç« .tex"
          "main_ç¬¬ä¸‰ç« .tex"
          "main_ç¬¬å››ç« .tex"
          "main_ç¬¬äº”ç« .tex"
          "main_ç¬¬å…­ç« .tex"
          "main_ç¬¬ä¸ƒç« .tex"
        )
        
        for file in "${chapter_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ $file æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ“ $file å­˜åœ¨"
        done
        
        echo "âœ“ æ‰€æœ‰ç« èŠ‚æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
        
    - name: Create EPUB metadata
      run: |
        cat > docs/tex_output/metadata.yaml << 'EOF'
        ---
        title: "Happy-LLM å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹"
        subtitle: "ä»ç†è®ºåˆ°å®è·µ"
        author: "DataWhale"
        language: zh-CN
        subject: "å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹"
        description: "ä»NLPåŸºç¡€æ¦‚å¿µåˆ°å¤§æ¨¡å‹åº”ç”¨çš„å®Œæ•´æ•™ç¨‹ï¼ŒåŒ…å«ç†è®ºçŸ¥è¯†å’Œå®è·µä»£ç "
        publisher: "DataWhale"
        rights: "CC BY-NC-SA 4.0"
        identifier: "happy-llm-tutorial"
        cover-image: "docs/images/head.jpg"
        ---
        EOF
        
    - name: Check EPUB style file
      run: |
        echo "æ£€æŸ¥EPUBæ ·å¼æ–‡ä»¶..."
        if [ ! -f "docs/tex_output/epub-style.css" ]; then
          echo "âŒ epub-style.css æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ“ EPUBæ ·å¼æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
        
    - name: Test each chapter individually
      run: |
        cd docs/tex_output
        
        echo "ğŸ” å¼€å§‹æµ‹è¯•æ¯ä¸ªç« èŠ‚çš„ç¼–è¯‘..."
        
        chapter_files=(
          "main_å‰è¨€.tex:å‰è¨€"
          "main_ç¬¬ä¸€ç« .tex:ç¬¬ä¸€ç« "
          "main_ç¬¬äºŒç« .tex:ç¬¬äºŒç« "
          "main_ç¬¬ä¸‰ç« .tex:ç¬¬ä¸‰ç« "
          "main_ç¬¬å››ç« .tex:ç¬¬å››ç« "
          "main_ç¬¬äº”ç« .tex:ç¬¬äº”ç« "
          "main_ç¬¬å…­ç« .tex:ç¬¬å…­ç« "
          "main_ç¬¬ä¸ƒç« .tex:ç¬¬ä¸ƒç« "
        )
        
        failed_chapters=()
        
        for file_info in "${chapter_files[@]}"; do
          IFS=':' read -r file chapter_name <<< "$file_info"
          
          echo "ğŸ“– æµ‹è¯• $chapter_name ($file)..."
          
          # å°è¯•ç¼–è¯‘ä¸ºEPUB
          if pandoc "$file" \
            --from latex \
            --to epub \
            --output "${chapter_name}_test.epub" \
            --metadata-file=metadata.yaml \
            --css=epub-style.css \
            --toc \
            --number-sections \
            --epub-cover-image=../images/head.jpg 2>&1; then
            
            echo "âœ… $chapter_name ç¼–è¯‘æˆåŠŸ"
            rm -f "${chapter_name}_test.epub"
          else
            echo "âŒ $chapter_name ç¼–è¯‘å¤±è´¥"
            failed_chapters+=("$chapter_name")
          fi
        done
        
        echo ""
        echo "ğŸ“Š ç¼–è¯‘ç»“æœæ±‡æ€»:"
        if [ ${#failed_chapters[@]} -eq 0 ]; then
          echo "ğŸ‰ æ‰€æœ‰ç« èŠ‚ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âš ï¸  ä»¥ä¸‹ç« èŠ‚ç¼–è¯‘å¤±è´¥:"
          for chapter in "${failed_chapters[@]}"; do
            echo "   - $chapter"
          done
          echo ""
          echo "è¯·æ£€æŸ¥ä¸Šè¿°ç« èŠ‚çš„texæ–‡ä»¶å†…å®¹"
        fi
        
    - name: Convert main tex to EPUB
      run: |
        cd docs/tex_output
        
        echo "ğŸ“š å¼€å§‹ç¼–è¯‘å®Œæ•´çš„main.texä¸ºEPUB..."
        
        # ä½¿ç”¨main.texç¼–è¯‘ä¸ºEPUB
        pandoc main.tex \
          --from latex \
          --to epub \
          --output "Happy-LLM-æ•™ç¨‹.epub" \
          --metadata-file=metadata.yaml \
          --css=epub-style.css \
          --toc \
          --number-sections \
          --epub-cover-image=../images/head.jpg
        
        echo "EPUBç”Ÿæˆå®Œæˆï¼"
        ls -lh Happy-LLM-æ•™ç¨‹.epub
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size=$(stat -c%s "Happy-LLM-æ•™ç¨‹.epub")
        echo "æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚"
        
        if [ $file_size -lt 100000 ]; then
          echo "âŒ EPUBæ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        echo "âœ“ EPUBæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå¤§å°: $file_size å­—èŠ‚"
        
    - name: Upload EPUB artifact
      uses: actions/upload-artifact@v4
      with:
        name: Happy-LLM-æ•™ç¨‹.epub
        path: docs/tex_output/Happy-LLM-æ•™ç¨‹.epub
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: docs/tex_output/Happy-LLM-æ•™ç¨‹.epub
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - Happy-LLMæ•™ç¨‹EPUB
        body: |
          ## Happy-LLM å¤§è¯­è¨€æ¨¡å‹æ•™ç¨‹ EPUBç‰ˆæœ¬
          
          è‡ªåŠ¨ç”Ÿæˆçš„EPUBç”µå­ä¹¦ï¼ŒåŒ…å«å®Œæ•´çš„æ•™ç¨‹å†…å®¹ã€‚
          
          ### ğŸ“š åŒ…å«ç« èŠ‚
          - å‰è¨€
          - ç¬¬ä¸€ç«  NLPåŸºç¡€æ¦‚å¿µ
          - ç¬¬äºŒç«  Transformeræ¶æ„
          - ç¬¬ä¸‰ç«  é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹
          - ç¬¬å››ç«  å¤§è¯­è¨€æ¨¡å‹
          - ç¬¬äº”ç«  åŠ¨æ‰‹æ­å»ºå¤§æ¨¡å‹
          - ç¬¬å…­ç«  å¤§æ¨¡å‹è®­ç»ƒæµç¨‹å®è·µ
          - ç¬¬ä¸ƒç«  å¤§æ¨¡å‹åº”ç”¨
          
          ### ğŸ“– ç‰¹æ€§
          - æ”¯æŒç›®å½•å¯¼èˆª
          - ä»£ç é«˜äº®æ˜¾ç¤º
          - é€‚é…ä¸­æ–‡æ’ç‰ˆ
          - åŒ…å«å›¾ç‰‡å’Œè¡¨æ ¼
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½EPUBæ–‡ä»¶
          2. ä½¿ç”¨æ”¯æŒEPUBçš„é˜…è¯»å™¨æ‰“å¼€
          3. æ¨èï¼šCalibreã€Apple Booksã€Kindle
          
          ### ğŸ“ åé¦ˆ
          - [GitHub Issues](https://github.com/datawhalechina/happy-llm/issues)
          - [è®¨è®ºåŒº](https://github.com/datawhalechina/happy-llm/discussions)
          
          ---
          *è‡ªåŠ¨ç”Ÿæˆäº ${{ github.event.head_commit.timestamp }}*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 